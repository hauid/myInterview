

要实现限流、熔断等功能，首先要解决的问题是如**何实时采集服务(资源)调用信息**。例如将某一个接口设置的**限流阔值 1W/tps**，那首先如何判断**当前的 TPS** 是多少？Alibaba Sentinel 采用**滑动窗口**来实现实时数据的统计。



**滑动窗口实现关键在于时间窗口的测量**

![img](https://picx.zhimg.com/v2-48f1b68e159f77b807f1cfddbbb242bd_1440w.png)

`Sentinel` 的单机限流 ，和 `RateLimiter` 有什么区别呢？



**公平性证明**：多个流最终会收敛到相同的窗口大小（公平带宽分配），数学上**可通过微分方程或博弈论模型分析**。

(见)

- **1、快速失败：直接失败**
- **2、Warm Up：预热模式，根据codeFactory的值（默认3），从阈值/codeFactory，经过预热时长，才达到设置的QPS阈值。比如设置QPS为90，设置预热为10秒，则最初的阈值为90/3=30，经过10秒后才达到90。**
- **3、排队等待：比如设置阈值为10，超时时间为500毫秒，当第11个请求到的时候，不会直接报错，而是等待500毫秒，如果之后阈值还是超过10，则才会被限流。**



![img](https://pic3.zhimg.com/v2-4d4810719b10e473b9b7a40f53dd6460_1440w.jpg)



### `集群限流`方案

`内嵌模式`，即 发Token 的操作，有**其中某一个实例完成，其他 Client 通过向 Server 请求**，获取访问许可。

`独立模式`，即作为独立的 **token server** 进程启动，独立部署，隔离性好，但是需要额外的部署操作。



核心的 `集群限流`方案了， 在`秒杀系统`设计中，我们谈到很多场景都是以单机作为具体案例进行分析，如果我们的系统要扩容，那么如何做好`限流方案`。假设集群中有 10 台机器，我们给每台机器设置单机限流阈值为`10 QPS`，理想情况下整个集群的限流阈值就为`100 QPS`。







































