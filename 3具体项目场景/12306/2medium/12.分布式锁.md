#### 库存扣减需要分布式锁

业务复杂,读出来需要做大量的前置数据校验,分布式环境下先读后写的场景,需要保证原子性操作



#### 分布式锁底层原理

设计到锁的重入,锁的释放和加锁怎么控制

原生的原子命令setnx,底层数据结构 2层哈希

一层业务key 第二层key就是线程的id实现加锁解锁的绑定 		

第二层的value就是一个count,实现一个可重入的功能



#### 分布式锁可能的问题

锁丢失问题,单机QPS一般上限是10万级别

加到主节点,主节点宕机了,集群哨兵监听到主节点宕机进行主从切换,从节点恢复对外提供的服务后,从节点上面没锁,**这把锁可能被其他服务获取到**,导致同一时刻可能有两个服务都认为自己得到了锁,产生业务异常

解决方案:

- RedLock红锁 一次性多加几把锁,全部加成功之后才说明加锁成功,影响性能,没有完全解决问题,知识概率问题

